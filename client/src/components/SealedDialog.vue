<template>
	<modal @close="cancel">
		<h2 slot="header">Start {{ teamSealed ? "Team " : "" }}Sealed</h2>
		<div slot="body" class="sealed-dialog">
			<div class="sealed-dialog-settings">
				<div>
					<h3>
						How many boosters for each {{ teamSealed ? "team " : "player" }} (default is
						{{ teamSealed ? "12" : "6" }})?
					</h3>
					<input
						type="number"
						min="4"
						max="24"
						step="1"
						id="input-boostersPerPlayer"
						class="swal2-input"
						style="display: block; margin: auto"
						:placeholder="`Boosters per ${teamSealed ? 'team ' : 'player'}`"
						v-model.number="boostersPerPlayer"
					/>
				</div>
				<div class="teams-selector" v-if="teamSealed">
					<h3>Assign players to a team:</h3>
					<div class="teams">
						<div v-for="(team, idx) in teams" :key="idx" class="team">
							<div>Team #{{ idx + 1 }}</div>
							<draggable class="team-drag-target" group="teams" :list="team" :animation="200">
								<div v-for="uid in team" :key="uid" class="player">{{ userById(uid)?.userName }}</div>
							</draggable>
						</div>
					</div>
				</div>
				<div>
					<h3>(Optional) Customize the set of each booster:</h3>
					<div class="input-customBoosters">
						<select
							class="standard-input custom-booster"
							v-for="(val, idx) in customBoosters"
							:key="idx"
							:id="'custom-booster-select-' + idx"
							v-model="customBoosters[idx]"
						>
							<option value="">(Default)</option>
							<option value="random">Random set from Card Pool</option>
							<option value="" class="option-separator" disabled>————————————————</option>
							<option v-for="s in MTGASets" :key="s.code" :value="s.code">
								{{ s.fullName }}
							</option>
							<option value="" class="option-separator" disabled>————————————————</option>
							<option v-for="s in PrimarySets" :key="s.code" :value="s.code">
								{{ s.fullName }}
							</option>
						</select>
					</div>
				</div>
			</div>
		</div>
		<div class="actions" slot="footer">
			<button class="cancel" @click="cancel">Cancel</button>
			<button class="confirm" @click="distribute">Distribute Boosters</button>
		</div>
	</modal>
</template>

<script setup lang="ts">
import { ref, watch, toRefs } from "vue";
import Modal from "./Modal.vue";
import Draggable from "vuedraggable";
import { UserID } from "../../../src/IDTypes";
import { UserData } from "../../../src/Session/SessionTypes";
import Constant from "../../../src/data/constants.json";
import SetsInfos from "../SetInfos";
import { SetCode } from "../../../src/Types";

const props = withDefaults(
	defineProps<{
		users: UserData[];
		teamSealed: Boolean;
	}>(),
	{ teamSealed: () => false }
);
const { users, teamSealed } = toRefs(props);

const teams = ref([[], [], [], []] as UserID[][]);
const boostersPerPlayer = ref(teamSealed.value ? 12 : 6);
const customBoosters = ref(Array(boostersPerPlayer.value).fill(""));

// Defaults to two teams, distribute players among them.
for (let i = 0; i < users.value.length; i++) teams.value[i % 2].push(users.value[i].userID);

const PrimarySets = Constant.PrimarySets.filter((s) => !Constant.MTGASets.includes(s)).map((s: string) => {
	return { code: s, fullName: SetsInfos[s].fullName };
});
const MTGASets = Constant.MTGASets.slice()
	.reverse()
	.map((s: string) => {
		return { code: s, fullName: SetsInfos[s].fullName };
	});

const emit = defineEmits<{
	(e: "cancel"): void;
	(e: "distribute", boostersPerPlayer: number, customBoosters: SetCode[], teams: UserID[][]): void;
}>();

// Methods
const userById = (uid: UserID) => users.value.find((user) => user.userID === uid);
const cancel = () => emit("cancel");
const distribute = () => emit("distribute", boostersPerPlayer.value, customBoosters.value, teams.value);

// Watch
watch(boostersPerPlayer, () => {
	while (customBoosters.value.length < boostersPerPlayer.value) customBoosters.value.push("");
	while (customBoosters.value.length > boostersPerPlayer.value) customBoosters.value.pop();
});
</script>

<style scoped>
.sealed-dialog {
	text-align: center;
}

.option-separator {
	color: #888;
}

.input-customBoosters {
	height: 10em;
	overflow-x: hidden;
	overflow-y: auto;
	display: grid;
	grid-template-columns: 1fr 1fr 1fr;
	grid-column-gap: 0.5em;
	padding: 0.5em;
	margin: 0.25em 0.5em;
	background-color: #ffffff10;
	border-radius: 0.5em;
	align-content: start;
}

.custom-booster {
	height: 2.5em;
}

.teams {
	display: flex;
	align-items: start;
	justify-content: center;
	gap: 1em;
}

.team {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
}

.team-drag-target {
	display: flex;
	flex-direction: column;
	background-color: #ffffff20;
	min-width: 10em;
	min-height: 5em;
	border-radius: 0.5em;
	padding: 0.5em;
	gap: 0.2em;
}
.player {
	cursor: grab;
	user-select: none;
	background-color: #ffffff20;
	border-radius: 0.5em;
	padding: 0.2em 0.5em;
	max-width: 9em;
	overflow: hidden;
	text-overflow: ellipsis;
}
</style>
